<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="copyright" content="All Rights Reserved, Copyright (C) 2013, Wuyeguo, Ltd."/>
    <title>EasyUI Web Admin Power by Wuyeguo</title>
    <link rel="stylesheet" type="text/css" href="../easyui/1.3.4/themes/default/easyui.css"/>
    <link rel="stylesheet" type="text/css" href="../css/wu.css"/>
    <link rel="stylesheet" type="text/css" href="../css/icon.css"/>
    <link rel="stylesheet" href="../kindeditor/themes/default/default.css"/>
    <script type="text/javascript" src="../js/jquery-1.8.0.min.js"></script>
    <script type="text/javascript" src="../easyui/1.3.4/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../easyui/1.3.4/locale/easyui-lang-zh_CN.js"></script>
    <script charset="utf-8" src="../kindeditor/kindeditor-all.js"></script>
    <script charset="utf-8" src="../kindeditor/lang/zh-CN.js"></script>
    <script type="text/javascript" src="../easyui/1.3.4/datagrid-filter.js"></script>
</head>
<body>
<div class="easyui-layout" data-options="fit:true">
    <div data-options="region:'center',border:false">
        <!-- Begin of toolbar -->
        <div id="wu-toolbar-forecast">

            <div class="wu-toolbar-searchForecast">
                <label>运营类型:</label>
                <select id="type_search" class="easyui-combobox" name="type" panelHeight="auto" style="width:100px;">
                    <option value="" selected="selected">全部</option>
                    <option value="101">首页顶部轮播图</option>
                    <option value="102">首页中部轮播图</option>
                    <option value="103">资讯轮播图</option>
                    <option value="104">预测轮播图</option>
                    <option value="105">赛事轮播图</option>
                    <option value="107">注册页轮播图</option>
                    <option value="108">启动图</option>
                    <option value="109">首页弹框</option>
                    <option value="206">公告</option>
                </select>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <label>创建时间:</label>
                <input class="easyui-datetimebox" id="operation_create_begin" name="startDate"
                       data-options="showSeconds:true" style="width:150px">
                -
                <input class="easyui-datetimebox" id="operation_create_end" name="endDate"
                       data-options="showSeconds:true" style="width:150px">
                &nbsp;&nbsp;&nbsp;&nbsp;
                <label>标题：</label><input id="title_search" class="wu-text" style="width:100px">
                &nbsp;&nbsp;&nbsp;&nbsp;
                <label>审核状态:</label>
                <select id="state_search" class="easyui-combobox" name="state" panelHeight="auto" style="width:60px;">
                    <option value="" selected="selected">全部</option>
                    <option value="0">待审核</option>
                    <option value="1">通过</option>
                    <option value="2">拒绝</option>
                </select>
                <a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick="searchsearch()">开始检索</a>
                <a href="#" class="easyui-linkbutton" iconCls="icon-reload" onclick="clearBox()">重置查询</a>
            </div>

            <hr/>

            <div class="toolbar-operation-button">
                <a href="#" class="easyui-linkbutton" iconCls="icon-remove" onclick="open_add_dialog()"
                   plain="true">新增</a>
                <a href="#" class="easyui-linkbutton" iconCls="icon-remove" onclick="open_edit_dialog()"
                   plain="true">编辑</a>
                <a href="#" class="easyui-linkbutton" iconCls="icon-remove" onclick="open_audit_ok_confirm()"
                   plain="true">审核通过</a>
                <a href="#" class="easyui-linkbutton" iconCls="icon-remove" onclick="open_audit_fail_confirm()"
                   plain="true">审核拒绝</a>
                <a href="#" class="easyui-linkbutton" iconCls="icon-remove" onclick="open_del_confirm()"
                   plain="true">删除</a>
                <a href="#" class="easyui-linkbutton" iconCls="icon-reload" onclick="reload()"
                   plain="true">刷新</a>
                <a href="#" class="easyui-linkbutton" iconCls="icon-save" onclick="openUpload()" plain="true">上传图片</a>
            </div>

        </div>
        <!-- End of toolbar -->
        <table id="dg" toolbar="#wu-toolbar-forecast"></table>
    </div>
</div>
<!-- Begin of easyui-dialog -->
<div id="dialog-operation" class="easyui-dialog" data-options="closed:true,iconCls:'icon-save'"
     style="width:750px; padding:10px;">
    <form id="form-add-operation" method="post">
        <input type="hidden" id="id_operation_add" name="id"/>
        <table>
            <tr>
                <td width="60" align="right">标题:</td>
                <td><input type="text" name="title" id="title_add" class="easyui-validatebox"
                           data-options="required:true,validType:length>0" style="width: 264px!important;"/></td>
                <td><label>运营类型:</label></td>
                <td><select id="type" class="easyui-combobox" name="type" panelHeight="auto" style="width:234px;">
                    <option value="101" selected="selected">首页顶部轮播图</option>
                    <option value="102">首页中部轮播图</option>
                    <option value="103">资讯轮播图</option>
                    <option value="104">预测轮播图</option>
                    <option value="105">赛事轮播图</option>
                    <option value="107">注册页轮播图</option>
                    <option value="108">启动图</option>
                    <option value="109">首页弹框</option>
                    <option value="206">公告</option>
                </select></td>
            </tr>
            <tr>
                <td align="right">排序:</td>
                <td><input id="orderNo_add" type="text" name="orderNo" class="easyui-validatebox"/>
                </td>
                <td align="right">图片地址:</td>
                <td>
                    <input type="text" name="iconUrl" id="iconUrl_add" class="easyui-validatebox"
                           data-options="validType:'url'"
                           style="width:230px!important;"/>
                    <span class="l-btn-text icon-search l-btn-icon-left" onclick="showAbbr()"
                          style="cursor:pointer">&nbsp;&nbsp;&nbsp;&nbsp;</span>
                </td>
            </tr>
            <tr>
                <td align="right">生效时间:</td>
                <td><input type="text" id="sTimeDia_operation_add" name="startTime" class="easyui-datetimebox"
                           style="width:150px;"/>
                </td>
                <td align="right">失效时间:</td>
                <td><input type="text" id="eTimeDia_operation_add" name="endTime" class="easyui-datetimebox"
                           style="width:150px;"/>
                </td>
            </tr>
            <tr>
                <td valign="top" align="right">跳转地址:</td>
                <td colspan="3">
                    <!--<textarea name="content" rows="6" class="wu-textarea" style="width:260px"></textarea>-->
                    <!--<textarea id="content_operation_add" rows="6" name="bootContent" class="easyui-validatebox"-->
                    <!--style="width:600px;"-->
                    <!--data-options="required:true,validType:'length[1,1000000]'"-->
                    <!--invalidMessage="最大长度不能超过1000000"></textarea>-->
                    <input id="content_operation_add" type="text" name="bootContent" class="easyui-validatebox"
                           style="width: 280px!important;"/>
                </td>
            </tr>

            <!--<tr>-->
            <!--<td>引导内容提示：</td>-->
            <!--<td>-->

            <!--跳转到H5页面：<span style="color: red;">{type:1, value:"https://www.baidu.com/"}</span></br>-->

            <!--</td>-->
            <!--</tr>-->
        </table>
    </form>
</div>
<div id="dialog-imaAbbr" class="easyui-dialog" data-options="closed:true,iconCls:'icon-save'"
     style="width:480px; height:480px;padding:10px;">
    <div id="abbrList" style="overflow: auto;">
    </div>
</div>
<div id="dialog-upload" class="easyui-dialog" data-options="closed:true,iconCls:'icon-save'"
     style="width:700px; padding:10px;">
    <form id="form-upload" method="post" enctype="multipart/form-data">
        <div style="margin-top: 100px;margin-left: 200px;margin-bottom: 100px;">
            <table>
                <tr>
                    <td width="60" align="right">图片上传:</td>
                    <td><input type="file" onchange="change_photo()" id="file_upload_newsList" name="file_upload"/></td>
                </tr>
                <tr id="showTr">
                    <td><label>图片预览</label></td>
                    <td>
                        <div id="Imgdiv_newsList"><img id="Img_newsList" width="200px" height="200px"/></div>
                    </td>
                </tr>
            </table>
        </div>
    </form>
</div>
<!-- End of easyui-dialog -->
<script type="text/javascript">
    var endDate = new Date();
    var startDate = new Date();
    startDate.setDate(startDate.getDate() - 1);
    var feedback_state = {
        0: "待审核",
        1: "<span style='color: green;'>通过</span>",
        2: "<span style='color: red;'>拒绝</span>"
    }

    $(document).ready(function () {
        var begin = new Date();
        var end = new Date();
        begin.setMonth(begin.getMonth() - 1);
        $('#operation_create_begin').datetimebox('setValue', formatterDate(begin));
        $('#operation_create_end').datetimebox('setValue', formatterDate(end));
        loadTab();
    });

    function formatterDate(date) {
        var day = date.getDate() > 9 ? date.getDate() : "0" + date.getDate();
        var month = (date.getMonth() + 1) > 9 ? (date.getMonth() + 1) : "0" + (date.getMonth() + 1);
        var hor = date.getHours();
        var min = date.getMinutes();
        var sec = date.getSeconds();
        return date.getFullYear() + '-' + month + '-' + day + " " + hor + ":" + min + ":" + sec;
    };

    /**
     * 手动刷新表格数据
     */
    function reload() {
        $("#dg").datagrid("reload");
    }

    /**
     * 根据条件查询
     */
    function searchsearch() {
        var startDate = $("#operation_create_begin").datetimebox("getValue");
        var endDate = $("#operation_create_end").datetimebox("getValue");
        if ((startDate.length != 0 && endDate.length == 0) || (startDate.length == 0 && endDate.length != 0)) {
            $.messager.alert('信息提示', '开始日期、结束日期必选', 'info');
            return;
        }
        if (startDate.length != 0 && endDate.length != 0 && !compareTime(startDate, endDate)) {
            $.messager.alert('信息提示', '开始日期不能大于结束日期', 'info');
            return;
        }
        $('#dg').datagrid('load', {
            "type": $("#type_search").combobox("getValue"),
            "createTimeBegin": startDate,
            "createTimeEnd": endDate,
            "title": $("#title_search").val(),
            "state": $("#state_search").combobox("getValue")
        });
    }

    function clearBox() {
        $("#type_search").combobox("setValue", '');
        $("#title_search").val("");
        $("#state_search").combobox("setValue", '');
        var begin = new Date();
        var end = new Date();
        begin.setMonth(begin.getMonth() - 1);
        $("#operation_create_begin").datetimebox("setValue", formatterDate(begin));
        $("#operation_create_end").datetimebox("setValue", formatterDate(end));
        searchsearch()
    }

    /**
     * 时间比较函数
     */
    function compareTime(startTime, endTime) {
        var startTimes = startTime.substring(0, 10).split('-');
        var endTimes = endTime.substring(0, 10).split('-');
        startTime = startTimes[1] + '-' + startTimes[2] + '-' + startTimes[0] + ' ' + startTime.substring(10, 19);
        endTime = endTimes[1] + '-' + endTimes[2] + '-' + endTimes[0] + ' ' + endTime.substring(10, 19);
        var thisResult = (Date.parse(endTime) - Date.parse(startTime)) / 3600 / 1000;
        if (thisResult < 0 || thisResult == 0) {
            return false;
        } else if (thisResult > 0) {
            return true;
        } else {
            $.messager.alert('信息提示', '时间异常', 'info');
        }
    }

    var operationTypeName = {
        101: "首页顶部轮播图",
        102: "首页中部轮播图",
        103: "资讯轮播图",
        104: "预测轮播图",
        105: "赛事轮播图",
        107: "注册页轮播图",
        108: "启动图",
        109: "首页弹框",
        206: "公告"
    }


    function loadTab() {
        /**
         * Name 载入数据
         */
        $('#dg').datagrid({
            url: "/admin/operation/page",
            method: "get",
            queryParams: {
                createTimeEnd: $('#operation_create_end').datetimebox('getValue'),
                createTimeBegin: $('#operation_create_begin').datetimebox('getValue')
            },
            rownumbers: true,  //是否显示行号
            singleSelect: false,
            pagination: true,
            fitColumns: true,
            pageSize: 20,
            fit: true,
            showFooter: true,
            columns: [[
                {checkbox: true},
                {field: 'id', title: 'ID', width: 50, align: 'center'},
                {field: 'title', title: '标题', width: 100, align: 'center'},
                {
                    field: 'type', title: '运营类型', width: 100, align: 'center', formatter: function (value, row, index) {
                        return operationTypeName[row.type]
                    }
                },
                {field: 'iconUrl', title: '图片地址', width: 200, align: 'center'},
                {field: 'orderNo', title: '排序', width: 200, align: 'center'},
                {
                    field: 'createTime',
                    title: '创建时间',
                    width: 100,
                    align: 'center',
                    formatter: function (value, row, index) {
                        var date = new Date(row.createTime);
                        return formatterDate(date);
                    }
                },
                {
                    field: 'state', title: '状态', width: 50, align: 'center', formatter: function (value, row, index) {
                        return feedback_state[row.state]
                    }
                },
                {
                    field: 'bootContent',
                    title: '跳转地址',
                    width: 100,
                    align: 'center',
                    formatter: function (value, row, index) {
                        console.log(value)
                        try {
                            return JSON.parse(value).value
                        } catch (e) {
                            return value
                        }
                    }
                },
                {
                    field: 'startTime',
                    title: '生效时间',
                    width: 100,
                    align: 'center',
                    formatter: function (value, row, index) {
                        var date = new Date(row.startTime);
                        return formatterDate(date);
                    }
                },
                {
                    field: 'endTime',
                    title: '失效时间',
                    width: 100,
                    align: 'center',
                    formatter: function (value, row, index) {
                        var date = new Date(row.endTime);
                        return formatterDate(date);
                    }
                }
            ]]
        });
    }

    function item() {
        var item = $("#dg").datagrid("getChecked");
        if (item.length != 1) {
            $.messager.alert("提示", "请选择一条进行操作");
            return
        }
        return item[0]
    }

    function get_selected_ids() {
        var item = $("#dg").datagrid("getChecked");
        if (item.length == 0) {
            $.messager.alert("提示", "请选择一条进行操作");
            return
        }
        var ids = ''
        item.forEach(function (value, index, array) {
            ids += value.id + ","
        })
        return ids
    }

    function open_del_confirm() {
        var id = get_selected_ids();
        $.messager.confirm("确认", "确认删除吗？", function (r) {
            if (r) {
                del(id)
            }
        })
    }

    function open_audit_ok_confirm() {
        var ids = get_selected_ids()
        $.messager.confirm("确认", "确认审核通过吗？", function (r) {
            if (r) {
                audit_ok(ids)
            }
        })
    }

    function open_audit_fail_confirm() {
        var ids = get_selected_ids()
        $.messager.confirm("确认", "确认审核拒绝吗？", function (r) {
            if (r) {
                audit_fail(ids)
            }
        })
    }

    function del(id) {
        $.ajax({
            type: 'POST',
            url: '/admin/operation/del',
            data: JSON.stringify({id: id}),
            success: function (data) {
                if (!data) {
                    $.messager.alert("提示", "操作失败")
                    return
                }
                reload()
            },
            dataType: 'json',
            contentType: "application/json"
        });
    }

    function audit_ok(id) {
        $.ajax({
            type: 'POST',
            url: '/admin/operation/audit/ok',
            data: JSON.stringify({id: id}),
            success: function (data) {
                if (!data) {
                    $.messager.alert("提示", "操作失败")
                    return
                }
                reload()
            },
            dataType: 'json',
            contentType: "application/json"
        });
    }

    function audit_fail(id) {
        $.ajax({
            type: 'POST',
            url: '/admin/operation/audit/fail',
            data: JSON.stringify({id: id}),
            success: function (data) {
                if (!data) {
                    $.messager.alert("提示", "操作失败")
                    return
                }
                reload()
            },
            dataType: 'json',
            contentType: "application/json"
        });
    }

    /**
     * Name 打开添加窗口
     */
    function open_add_dialog() {
        $('#dialog-operation').dialog({
            closed: false,
            modal: true,
            title: "添加",
            onOpen: function () {
                var begin = new Date();
                var end = new Date();
                end.setMonth(end.getMonth() + 1);
                $('#form-add-operation').form('clear');
                $('#sTimeDia_operation_add').datetimebox('setValue', formatterDate(begin));
                $('#eTimeDia_operation_add').datetimebox('setValue', formatterDate(end));
                $("#type").combobox("setValue", 101)
                $("#orderNo_add").val(0)
            },
            buttons: [{
                text: '确定',
                iconCls: 'icon-ok',
                handler: add
            }, {
                text: '取消',
                iconCls: 'icon-cancel',
                handler: function () {
                    $('#dialog-operation').dialog('close');
                }
            }]
        });
    }

    /**
     * Name 添加记录
     */
    function add() {
        $('#form-add-operation').form('submit', {
            url: '/admin/operation/add',
            success: function (data) {
                data = JSON.parse(data)
                if (!data.ok) {
                    $.messager.alert("提示", data.msg)
                    return
                }
                var begin = new Date();
                var end = new Date();
                begin.setMonth(begin.getMonth() - 1);
                $('#operation_create_begin').datetimebox('setValue', formatterDate(begin));
                $('#operation_create_end').datetimebox('setValue', formatterDate(end));
                searchsearch()
                $('#dialog-operation').dialog('close');
            }
        });
    }

    function open_edit_dialog() {
        var item = $("#dg").datagrid("getChecked");
        if (item.length != 1) {
            $.messager.alert("提示", "至少选择一条记录");
            return
        }
        $('#dialog-operation').dialog({
            closed: false,
            modal: true,
            title: "编辑",
            onOpen: function () {
                console.log(item[0])
                $('#form-add-operation').form('clear');
                $("#orderNo_add").val(item[0].orderNo)
                $("#id_operation_add").val(item[0].id)
                $("#type").combobox("setValue", item[0].type)
                $("#iconUrl_add").val(item[0].iconUrl)
                $("#title_add").val(item[0].title)
                $("#sTimeDia_operation_add").datetimebox("setValue", item[0].startTime)
                $("#eTimeDia_operation_add").datetimebox("setValue", item[0].endTime)
                $("#content_operation_add").val(JSON.parse(item[0].bootContent).value)
            },
            buttons: [{
                text: '确定',
                iconCls: 'icon-ok',
                handler: edit
            }, {
                text: '取消',
                iconCls: 'icon-cancel',
                handler: function () {
                    $('#dialog-operation').dialog('close');
                }
            }]
        });
    }

    function edit() {
        $('#form-add-operation').form('submit', {
            url: '/admin/operation/edit',
            success: function (data) {
                data = JSON.parse(data)
                if (!data.ok) {
                    $.messager.alert("提示", data.msg)
                    return
                }
                reload()
                $('#dialog-operation').dialog('close');
            }
        });
    }

    /**
     * 缩略图列表展示
     */
    function showAbbr() {
        $('#dialog-imaAbbr').dialog({
            closed: false,
            modal: true,
            title: "选择",
            onOpen: function () {
                $.ajax({
                    url: '/news/imgAbbr',
                    method: "get",
                    dataType: "json",
                    success: function (data) {
                        var html_str = "";
                        for (var i = 0; i < data.length; i++) {
                            var dirName = data[i].dirName;
                            html_str += "<div style=\"margin:5px;border:0.5px solid gray\">" +
                                "<p style=\"width:100%;\">文件夹名:" + dirName + ",共" + data[i].fileCount + "个文件</p>";
                            var imgArray = data[i].files;
                            for (var j = 0; j < imgArray.length; j++) {
                                html_str += "<img width=\"50px\" style=\"margin:2px\" onclick='setSrc(this.src)' src=\"https://res.jygoal.com/img/" + dirName + "/" + imgArray[j].fileName + "\">";
                            }
                            html_str += "</div>";
                        }
                        $("#abbrList").html(html_str);
                    }
                })
            },
            buttons: [{
                text: '关闭',
                iconCls: 'icon-cancel',
                handler: function () {
                    $('#dialog-imaAbbr').dialog('close');
                }
            }]
        });
    }

    function setSrc(str) {
        $("input[name='iconUrl']").val(str);
        $('#dialog-imaAbbr').dialog('close');
    }

    function openUpload() {
        $('#dialog-upload').dialog({
            closed: false,
            modal: true,
            title: "上传图片",
            buttons: [{
                text: '确定',
                iconCls: 'icon-ok',
                handler: uploadPic
            }, {
                text: '取消',
                iconCls: 'icon-cancel',
                handler: function () {
                    $('#dialog-upload').dialog('close');
                }
            }]
        });
    }

    /**
     * 图片上传选择事件
     */
    function change_photo() {
        PreviewImage($("input[name='file_upload']")[0], 'Img_newsList', 'Imgdiv_newsList');
    }

    /**
     * 图片预览方法
     */
    function PreviewImage(fileObj, imgPreviewId, divPreviewId) {
        var allowExtention = ".jpg,.bmp,.gif,.png";//允许上传文件的后缀名document.getElementById("hfAllowPicSuffix").value;
        var extention = fileObj.value.substring(fileObj.value.lastIndexOf(".") + 1).toLowerCase();
        var browserVersion = window.navigator.userAgent.toUpperCase();
        if (allowExtention.indexOf(extention) > -1) {
            if (fileObj.files) {//HTML5实现预览，兼容chrome、火狐7+等
                if (window.FileReader) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById(imgPreviewId).setAttribute("src", e.target.result);
                    }
                    reader.readAsDataURL(fileObj.files[0]);
                } else if (browserVersion.indexOf("SAFARI") > -1) {
                    alert("不支持Safari6.0以下浏览器的图片预览!");
                }
            } else if (browserVersion.indexOf("MSIE") > -1) {
                if (browserVersion.indexOf("MSIE 6") > -1) {//ie6
                    document.getElementById(imgPreviewId).setAttribute("src", fileObj.value);
                } else {//ie[7-9]
                    fileObj.select();
                    if (browserVersion.indexOf("MSIE 9") > -1)
                        fileObj.blur();//不加上document.selection.createRange().text在ie9会拒绝访问
                    var newPreview = document.getElementById(divPreviewId + "New");
                    if (newPreview == null) {
                        newPreview = document.createElement("div");
                        newPreview.setAttribute("id", divPreviewId + "New");
                        newPreview.style.width = document.getElementById(imgPreviewId).width + "px";
                        newPreview.style.height = document.getElementById(imgPreviewId).height + "px";
                        newPreview.style.border = "solid 1px #d2e2e2";
                    }
                    newPreview.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src='" + document.selection.createRange().text + "')";
                    var tempDivPreview = document.getElementById(divPreviewId);
                    tempDivPreview.parentNode.insertBefore(newPreview, tempDivPreview);
                    tempDivPreview.style.display = "none";
                }
            } else if (browserVersion.indexOf("FIREFOX") > -1) {//firefox
                var firefoxVersion = parseFloat(browserVersion.toLowerCase().match(/firefox\/([\d.]+)/)[1]);
                if (firefoxVersion < 7) {//firefox7以下版本
                    document.getElementById(imgPreviewId).setAttribute("src", fileObj.files[0].getAsDataURL());
                } else {//firefox7.0+
                    document.getElementById(imgPreviewId).setAttribute("src", window.URL.createObjectURL(fileObj.files[0]));
                }
            } else {
                document.getElementById(imgPreviewId).setAttribute("src", fileObj.value);
            }
        } else {
            alert("仅支持" + allowExtention + "为后缀名的文件!");
            fileObj.value = "";//清空选中文件
            if (browserVersion.indexOf("MSIE") > -1) {
                fileObj.select();
                document.selection.clear();
            }
            fileObj.outerHTML = fileObj.outerHTML;
        }
    }

    /**
     * 上传图片
     */
    function uploadPic() {
        $('#form-upload').form('submit', {
            url: 'https://res.jygoal.com/uploadhandler.ashx?type=img&domain=jygoal.com',
            success: function (data) {
                /*  var obj = eval('(' + data + ')');
                  alert(obj.message);
                  if (obj.message == '上传成功') {
                      $.messager.alert('信息提示', '图片上传成功！', 'info');
                      $('#dialog-newsList').dialog('close');
                  }
                  else {
                      $.messager.alert('信息提示', '图片上传失败，请重新上传！', 'info');
                  }*/
            }
        });
        $('#dialog-upload').dialog('close');
    }


</script>
</body>
</html>